<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="refresh" content="300" />
    <title>Zendesk Support Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #121212;
        color: #e0e0e0;
        font-family: "Roboto", sans-serif;
      }
      .dashboard-card {
        background-color: #1e1e1e;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
      }
      .dashboard-card h3 {
        font-size: 1.5rem;
        color: #bb86fc;
        margin-bottom: 15px;
      }
      .metric {
        font-size: 3.5rem;
        font-weight: 700;
        color: #fff;
      }
      #last-updated {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 0.8rem;
        color: #666;
      }
      .list-group-item {
        background-color: #2a2a2a;
        color: #e0e0e0;
        border-color: #333;
      }
      .list-group-item strong {
        color: #03dac6;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid p-4">
      <div id="last-updated"></div>
      <div class="row">
        <div class="col-12 text-center mb-4">
          <h1 style="color: #bb86fc">Live Support Dashboard</h1>
        </div>
      </div>

      <div class="row">
        <div class="col-md-3 col-6">
          <div class="dashboard-card">
            <h3>New Tickets</h3>
            <p id="new-tickets" class="metric">...</p>
          </div>
        </div>
        <div class="col-md-3 col-6">
          <div class="dashboard-card">
            <h3>Open Tickets</h3>
            <p id="open-tickets" class="metric">...</p>
          </div>
        </div>
        <div class="col-md-3 col-6">
          <div class="dashboard-card">
            <h3>Urgent Tickets</h3>
            <p id="urgent-tickets" class="metric">...</p>
          </div>
        </div>
        <div class="col-md-3 col-6">
          <div class="dashboard-card">
            <h3>Solved Today</h3>
            <p id="solved-today" class="metric">...</p>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-md-6">
          <div class="dashboard-card">
            <h3>Oldest Open Tickets (5+)</h3>
            <ul id="aging-tickets" class="list-group text-start">
              <li class="list-group-item">Loading...</li>
            </ul>
          </div>
        </div>
        <div class="col-md-6">
          <div class="dashboard-card">
            <h3>Active Agents (Recent Updates)</h3>
            <ul id="active-agents" class="list-group text-start">
              <li class="list-group-item">Loading...</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Helper function to fetch data from our SECURE Vercel proxy
        async function fetchFromProxy(zendeskEndpoint) {
          try {
            // We pass the target Zendesk endpoint as a URL parameter to our proxy
            const response = await fetch(
              `/api/zendesk?endpoint=${encodeURIComponent(zendeskEndpoint)}`
            );
            if (!response.ok) {
              console.error(
                `Error fetching from proxy for ${zendeskEndpoint}: ${response.statusText}`
              );
              return null;
            }
            return await response.json();
          } catch (error) {
            console.error("Network or CORS error:", error);
            return null;
          }
        }

        function getTodayDateString() {
          const today = new Date();
          const year = today.getFullYear();
          const month = String(today.getMonth() + 1).padStart(2, "0");
          const day = String(today.getDate()).padStart(2, "0");
          return `${year}-${month}-${day}`;
        }

        // --- METRIC FETCHING FUNCTIONS (Now using the proxy) ---

        async function getTicketCounts() {
          const newData = await fetchFromProxy(
            "search.json?query=type:ticket status:new"
          );
          const openData = await fetchFromProxy(
            "search.json?query=type:ticket status<solved"
          );
          const urgentData = await fetchFromProxy(
            "search.json?query=type:ticket status<solved priority:urgent"
          );

          document.getElementById("new-tickets").textContent = newData
            ? newData.count
            : "Error";
          document.getElementById("open-tickets").textContent = openData
            ? openData.count
            : "Error";
          document.getElementById("urgent-tickets").textContent = urgentData
            ? urgentData.count
            : "Error";
        }

        async function getSolvedTodayCount() {
          const today = getTodayDateString();
          const data = await fetchFromProxy(
            `search.json?query=type:ticket status:solved solved>=${today}`
          );
          document.getElementById("solved-today").textContent = data
            ? data.count
            : "Error";
        }

        async function getAgingTickets() {
          const data = await fetchFromProxy(
            "search.json?query=type:ticket status:open order_by:created_at sort:asc&per_page=5"
          );
          const listElement = document.getElementById("aging-tickets");
          listElement.innerHTML = "";

          if (data && data.results.length > 0) {
            data.results.forEach((ticket) => {
              const daysOld = Math.floor(
                (new Date() - new Date(ticket.created_at)) /
                  (1000 * 60 * 60 * 24)
              );
              const listItem = document.createElement("li");
              listItem.className = "list-group-item";
              listItem.innerHTML = `<strong>#${
                ticket.id
              }</strong> - ${ticket.subject.substring(
                0,
                40
              )}... <em>(${daysOld} days old)</em>`;
              listElement.appendChild(listItem);
            });
          } else {
            listElement.innerHTML =
              '<li class="list-group-item">No aging tickets found.</li>';
          }
        }

        async function getActiveAgents() {
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);
          const data = await fetchFromProxy(
            `search.json?query=type:ticket status>new updated>=${
              yesterday.toISOString().split("T")[0]
            }&per_page=100`
          );
          const listElement = document.getElementById("active-agents");
          listElement.innerHTML = "";

          if (data && data.results.length > 0) {
            const agentIds = [
              ...new Set(
                data.results
                  .map((ticket) => ticket.assignee_id)
                  .filter((id) => id != null)
              ),
            ];
            if (agentIds.length > 0) {
              const usersData = await fetchFromProxy(
                `users/show_many.json?ids=${agentIds.join(",")}`
              );
              if (usersData) {
                usersData.users.forEach((user) => {
                  const listItem = document.createElement("li");
                  listItem.className = "list-group-item";
                  listItem.textContent = user.name;
                  listElement.appendChild(listItem);
                });
              }
            } else {
              listElement.innerHTML =
                '<li class="list-group-item">No agents with recent activity.</li>';
            }
          } else {
            listElement.innerHTML =
              '<li class="list-group-item">No recent ticket activity.</li>';
          }
        }

        function updateAllMetrics() {
          getTicketCounts();
          getSolvedTodayCount();
          getAgingTickets();
          getActiveAgents();
          document.getElementById(
            "last-updated"
          ).textContent = `Last Updated: ${new Date().toLocaleTimeString()}`;
        }

        updateAllMetrics();
      });
    </script>
  </body>
</html>
